# 家人拜年导航 - 产品文档（V1）

## 1. 产品目标
- 为家庭成员提供一个可登录、可保存、可共享（后续）站点的导航工具。
- 解决农村场景下定位漂移、地址不标准、亲戚家位置难找的问题。
- 以“标点管理 + 步行导航 + 云端同步”为核心，优先做稳定可用，再扩展高级功能。

## 2. 用户角色
- 普通用户：注册/登录、创建自己的站点、导航、删除自己的站点。
- 管理员（后续）：管理家庭成员、处理异常标点、治理共享数据。

## 3. 当前实现状态（基于当前代码）

### 3.1 已完成
- Flutter 腾讯地图接入与隐私初始化。
- 登录/注册页（用户名密码）。
- JWT token 本地存储（`shared_preferences`）。
- 云端标点加载、新增、删除（调用 FastAPI）。
- 地图点击新增标点。
- 当前定位点一键标记。
- 基础定位纠偏（精度过滤 + 跳点过滤 + 平滑）。
- 调起腾讯地图 App 步行导航。
- 后端 FastAPI + MySQL + Docker 基础部署。

### 3.2 未完成/需完善
- 标点编辑（前后端都未形成完整交互入口）。
- 标点分类（亲戚/补给点/集合点）与检索。
- 共享机制（当前仅“本人可见”）。
- 用户资料与密码修改。
- 后端接口标准化错误码与统一响应结构。
- 审计日志与操作回滚。
- 离线地图引导的可操作流程（当前只有提示文案）。
- CI/CD 发布链路打通到下载分发地址（Actions 已构建，但未自动发布到服务器目录）。

### 3.3 风险与技术债
- `lib/main.dart` 体量过大（UI、状态、网络、模型耦合在一个文件）。
- API 基础地址和腾讯 referer Key 硬编码。
- 无集成测试与端到端回归。
- 无数据迁移体系（后续字段演进有风险）。

## 4. 功能范围（V1）

### 4.1 账号与会话
- 注册、登录、退出登录。
- 401 处理：token 失效自动回登录页。

### 4.2 标点管理
- 标点列表（地图展示）。
- 新增：地图点击、定位点一键新增。
- 删除：仅本人标点可删除。
- 编辑（V1.1）：改名称、备注、坐标微调。

### 4.3 导航能力
- 从当前定位调起腾讯地图步行导航。
- 导航失败提示（未安装 App）。

### 4.4 稳定性与可观测
- 前端：网络失败提示、空态提示。
- 后端：`/health` 健康检查、容器化部署。

## 5. 非功能需求
- 性能：地图交互流畅，标点百级数据不卡顿。
- 安全：JWT、密码哈希存储、最小权限原则。
- 兼容：Android 优先，iOS 次优先。
- 可运维：Docker 一键部署，Nginx 反向代理。

## 6. 数据模型（当前）
- `users`：`id`, `username`, `password_hash`, `role`, `created_at`
- `markers`：`id`, `owner_id`, `title`, `note`, `lat`, `lng`, `visible`, `created_at`, `updated_at`

## 7. 迭代计划

### 里程碑 M1（本周）
- 目标：把当前功能做成“可稳定交付版本”。
- 任务：
  - 拆分 `lib/main.dart`（页面、服务、模型分层）。
  - 新增标点编辑入口（前端 + `PUT /markers/{id}` 对接）。
  - 增加接口超时与统一错误提示文案。
  - 增加后端基础日志（请求 id、路径、耗时）。

### 里程碑 M2（下周）
- 目标：实现家庭可协作。
- 任务：
  - 增加“共享标点”字段与接口（仅邀请成员可见）。
  - 增加成员关系表与邀请机制（简版：用户名邀请）。
  - 权限校验扩展：owner/editor/viewer。

### 里程碑 M3（后续）
- 目标：可运营与可回归。
- 任务：
  - GitHub Actions 产物自动发布到 `/apk` 分发目录。
  - 增加 smoke test（登录、新增、删除、导航链路）。
  - 增加监控告警（API 错误率、容器重启次数）。

## 8. 实施步骤（执行顺序）
1. 前端分层重构：`pages/`, `services/`, `models/`。
2. 标点编辑能力落地（先后端接口复用，再前端 UI）。
3. 后端统一错误码与日志。
4. 共享数据模型设计与迁移脚本。
5. 发布链路自动化（Actions -> 服务器分发目录）。

## 9. 验收标准（V1）
- 可注册登录，重启 App 后会话可恢复。
- 可加载个人标点，新增与删除实时生效。
- 失败场景有明确提示（网络异常/鉴权异常/无定位）。
- 可调起步行导航，失败有兜底提示。
- 后端容器重启后数据不丢失。

## 10. 版本记录
- V1.0：初版文档，覆盖当前实现与后续计划。
